# 第 5 章 编写主引导扇区代码

|本期版本|上期版本|
|:---:|:---:|
|`Wed Dec 28 11:53:25 CST 2022` | - |

## 5.2 欢迎来到主引导扇区

* 一个有效的主引导扇区，其最后两字节应当是 `0x55` 和 `0xAA`

### 5.4.1 显卡和显存

* 所有在个人计算机上使用的显卡，在加电自检之后都会把自己初始化到 `80 x 25` 的文本模式
* 一直以来， `0xB8000~0xBFFFF` 这段物理地址空间，是留给显卡的


### 5.4.2 初始化段寄存器

* Intel 的处理器不能允许将一个立即数传送到段寄存器

### 5.4.3 显存的访问和ASCII代码

* 屏幕上的每个字符对应着显存中的两个连续字节，前一个是字符的ASCII代码，后面是字符的显示属性
* 字符的显示属性分为两部分，低 4 位定义了前景色，高4位定义的是背景色




## 5.5  显示标号的汇编地址

### 5.5.1  标号

* 汇编地址： 该指令相对于程序或者段起始处的距离，以字节计。

```nasm
nasm -l exam.lst
```

### 5.5.2 如何显示十进制数字

* 只要把 AX 的内容不停地除以 10， 只需要 5 次，把每次的余数反向组合到一起，就是原来的数字
* 把每次相除得到余数加上 `0x30`, 在屏幕上显示就没问题了


### 5.5.4 分解数的各个数位


* 16位除以8位: `AX(被除数)`、`[R|M]8(除数)`、`AL(商)`、`AH(余数)`
* 32位除以16位: `DX(高16位):AX(低16位)/被除数`、`[R|M]16(除数)`、`AX(商)`、`DX(余数)`
* 因为除数是10， 余数自然比10小，我们可以在 `DL` 中取得

### 5.5.5 显示分解出来的各个数位

* 将 `AL` 中的内容加上 `0x30`， 以得到与该数字对应的 ASCII 代码

## 5.6 使程序进入无限循环状态

* 取得指令，然后执行，同时把 IP 的内容加上当前指令的长度，以指向吓一跳指令的偏移地址

## 5.7 完成并编译主引导扇区代码


* 伪指令 `times` 可用于重复它后面的指令若干次

```bash
# (512-2 - 307)D - 0x133  = 203D
nasm c05_mbr.asm -f bin -l c05_mbr.lst -o c05_mbr.bin
```


## 5.9 程序的调试技术

### 5.9.2 Bochs 下的程序调试入门

* 现代处理器在加电启动时，段寄存器 CS 的内容为 `0xF000`, 指令指针寄存器 IP 的内容为 `0xFFF0`
* 在刚刚启动时，处理器将其余（高位部分）的地址线强制位高电平